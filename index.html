<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Client-Only Photo Signer & Verifier</title>
    <link rel="stylesheet" href="style.css">

</head>
<body>
<header>
  <h1>Client-Only Photo Signer & Verifier <span class="pill">Ed25519 / P-256</span> <span class="pill">No backend</span></h1>
  <div class="host">Deploy: upload this file to GitHub Pages</div>
</header>
<main>
  <nav>
    <button data-tab="identities" class="active">Identities</button>
    <button data-tab="contacts">Contacts</button>
    <button data-tab="capture">Capture & Sign</button>
    <button data-tab="verify">Verify</button>
    <button data-tab="backup">Backup</button>
    <hr style="border-color:var(--muted); opacity:.5">
    <button data-tab="about">About</button>
  </nav>
  <section id="identities" class="tab">
    <div class="card">
      <h2>New Identity</h2>
      <div class="row">
        <div>
          <label>Display name</label>
          <input id="id-name" type="text" placeholder="e.g., Alice Photographer" />
        </div>
        <div>
          <label>Algorithm</label>
          <select id="id-algo">
            <option value="Ed25519" selected>Ed25519 (preferred)</option>
            <option value="P-256">P-256 (ECDSA)</option>
          </select>
        </div>
        <div>
          <label>Passphrase (encrypt private key export)</label>
          <input id="id-pass" type="password" placeholder="Optional (recommended for export)" />
        </div>
      </div>
      <div style="margin-top:8px">
        <button class="btn primary" id="btn-create-id">Create Identity</button>
      </div>
    </div>

    <div class="card">
      <h2>My Identities</h2>
      <div id="identity-list" class="grid"></div>
    </div>

    <div class="card">
      <h2>Import Private Identity</h2>
      <p class="muted">Paste an encrypted private JWK export produced by this app. Decrypts with your passphrase.</p>
      <label>Encrypted Export (JSON)</label>
      <textarea id="id-import-json" rows="6" class="mono" placeholder='{"name":"...","algo":"Ed25519", ...}'></textarea>
      <label>Passphrase</label>
      <input id="id-import-pass" type="password" />
      <div style="margin-top:8px">
        <button class="btn" id="btn-import-id">Import</button>
      </div>
    </div>
  </section>

  <section id="contacts" class="tab" style="display:none">
    <div class="card">
      <h2>New Contact</h2>
      <div class="row">
        <div>
          <label>Display name</label>
          <input id="contact-name" type="text" />
        </div>
        <div>
          <label>Algorithm</label>
          <select id="contact-algo">
            <option value="Ed25519" selected>Ed25519</option>
            <option value="P-256">P-256</option>
          </select>
        </div>
      </div>
      <label>Public Key (Base64URL or JWK)</label>
      <textarea id="contact-pub" rows="3" class="mono" placeholder="Base64URL raw key OR JWK JSON"></textarea>
      <div style="margin-top:8px"><button class="btn" id="btn-add-contact">Add Contact</button></div>
    </div>

    <div class="card">
      <h2>Scan Contact QR</h2>
      <div class="row">
        <div style="flex:2">
          <video id="qr-video" playsinline muted></video>
        </div>
        <div style="flex:1">
          <button class="btn" id="btn-start-scan">Start Camera</button>
          <button class="btn" id="btn-stop-scan">Stop</button>
          <div id="scan-status" class="foot">Idle</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Contacts</h2>
      <div id="contact-list" class="grid"></div>
    </div>
  </section>

  <section id="capture" class="tab" style="display:none">
    <div class="card">
      <h2>Capture / Load Image</h2>
      <div class="row">
        <div><input type="file" id="file-input" accept="image/*" /></div>
        <div><button class="btn" id="btn-open-camera">Use Camera</button></div>
        <div>
          <label>QR Corner</label>
          <select id="qr-corner">
            <option>TR</option><option>TL</option><option>BR</option><option>BL</option>
          </select>
        </div>
        <div>
          <label>QR Size (% of short side)</label>
          <input id="qr-size" type="text" value="15" />
        </div>
      </div>
      <div class="grid">
        <div>
          <h3>Preview</h3>
          <canvas id="canvas" width="640" height="480"></canvas>
          <div class="foot">The QR is placed after signing; hashing uses a black square at the same position.</div>
        </div>
        <div>
          <h3>Camera</h3>
          <video id="cam" autoplay playsinline style="max-height:360px"></video><br/>
          <button class="btn" id="btn-capture">Capture Frame</button>
          <div id="capture-status" class="foot">No camera</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Sign</h2>
      <div class="row">
        <div>
          <label>Signer Identity</label>
          <select id="sign-identity"></select>
        </div>
        <div>
          <label>Optional note</label>
          <input id="sign-note" type="text" placeholder="Short note" />
        </div>
      </div>
      <div style="margin-top:8px">
        <button class="btn primary" id="btn-sign">Hash + Sign + Embed QR</button>
        <button class="btn" id="btn-download">Download PNG</button>
      </div>
      <details>
        <summary>Signature payload</summary>
        <pre id="payload-view" class="mono"></pre>
      </details>
      <details>
        <summary>Verification report (self-check)</summary>
        <pre id="self-verify" class="mono"></pre>
      </details>
    </div>
  </section>

  <section id="verify" class="tab" style="display:none">
    <div class="card">
      <h2>Verify Image</h2>
      <div class="row">
        <div><input type="file" id="verify-file" accept="image/*" /></div>
        <div><input type="text" id="verify-url" placeholder="https://example.com/image.png (CORS required)" /></div>
        <div><button class="btn" id="btn-verify-url">Fetch & Verify</button></div>
      </div>
      <div class="grid">
        <div>
          <h3>Image</h3>
          <canvas id="verify-canvas" width="640" height="480"></canvas>
        </div>
        <div>
          <h3>Result</h3>
          <pre id="verify-report" class="mono"></pre>
        </div>
      </div>
    </div>
  </section>

  <section id="backup" class="tab" style="display:none">
    <div class="card">
      <h2>Backup / Restore</h2>
      <div class="row">
        <div>
          <label>Export Passphrase (for private keys)</label>
          <input id="backup-pass" type="password" />
        </div>
      </div>
      <div style="margin-top:8px">
        <button class="btn" id="btn-backup">Export Backup JSON</button>
      </div>
      <h3>Restore</h3>
      <textarea id="restore-json" rows="8" class="mono" placeholder="Paste backup JSON"></textarea>
      <label>Restore Passphrase</label>
      <input id="restore-pass" type="password" />
      <div style="margin-top:8px">
        <button class="btn" id="btn-restore">Restore</button>
      </div>
    </div>
  </section>

  <section id="about" class="tab" style="display:none">
    <div class="card">
      <h2>About</h2>
      <p>This single-file SPA implements a client-only photo signing and verification workflow: local identities, deterministic hashing with a blackened QR region, QR embedding, and verification.</p>
      <ul class="kvl">
        <li>Keys: Ed25519 (preferred) via WebCrypto, with P-256 fallback; @noble/ed25519 as optional fallback.</li>
        <li>QR: generated client-side; read via jsQR.</li>
        <li>Storage: IndexedDB via localForage.</li>
        <li>No build step. Deploy this <code>index.html</code> on GitHub Pages.</li>
      </ul>
      <p class="foot">Security note: Private keys are stored locally (browser storage). Use strong passphrases and dedicated profiles/devices for sensitive use.</p>
    </div>
  </section>
</main>

<!-- Dependencies via CDN (no build step) -->
<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@noble/ed25519@2.1.0/lib/index.umd.min.js"></script>

<script type="module" src="app.js"></script>

</body>
</html>
